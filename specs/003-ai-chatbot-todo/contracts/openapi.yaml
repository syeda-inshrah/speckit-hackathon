openapi: 3.0.3
info:
  title: Todo AI Chatbot API
  description: |
    AI-powered conversational todo application API with natural language task management.

    Phase III adds conversational interface using OpenAI Agents SDK and MCP (Model Context Protocol).
    Users can manage tasks through natural language conversations.

    **Key Features:**
    - Natural language task management
    - Conversational AI interface
    - MCP-based tool architecture
    - Stateless server design
    - Conversation persistence
  version: 2.0.0
  contact:
    name: Todo Application Support
    email: support@todoapp.com

servers:
  - url: http://localhost:8001
    description: Development server
  - url: https://api.todoapp.com
    description: Production server

paths:
  # ==========================================
  # PHASE II ENDPOINTS (Existing)
  # ==========================================

  /api/auth/signup:
    post:
      tags:
        - Authentication
      summary: Register a new user account
      description: Creates a new user account with email, password, and name. Returns JWT token and user data.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserSignup'
      responses:
        '201':
          description: User created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '400':
          description: Bad request - invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '409':
          description: Conflict - email already registered
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/auth/signin:
    post:
      tags:
        - Authentication
      summary: Authenticate user and return JWT token
      description: Authenticates user with email and password. Returns JWT token and user data.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UserSignin'
      responses:
        '200':
          description: Authentication successful
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuthResponse'
        '401':
          description: Unauthorized - invalid credentials
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'

  /api/{user_id}/tasks:
    get:
      tags:
        - Tasks
      summary: List all tasks for the authenticated user
      description: Returns all tasks for the specified user, ordered by creation date (newest first).
      parameters:
        - name: user_id
          in: path
          required: true
          description: The ID of the user whose tasks to retrieve
          schema:
            type: string
            format: uuid
        - name: status
          in: query
          required: false
          description: Filter tasks by status (all, pending, completed)
          schema:
            type: string
            enum: [all, pending, completed]
            default: all
      responses:
        '200':
          description: Tasks retrieved successfully
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/TaskResponse'
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - user does not have access to these tasks
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - bearerAuth: []

    post:
      tags:
        - Tasks
      summary: Create a new task for the authenticated user
      description: Creates a new task for the specified user.
      parameters:
        - name: user_id
          in: path
          required: true
          description: The ID of the user creating the task
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskCreate'
      responses:
        '201':
          description: Task created successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          description: Bad request - invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '401':
          description: Unauthorized - invalid or missing token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '403':
          description: Forbidden - user does not have access
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
      security:
        - bearerAuth: []

  /api/{user_id}/tasks/{task_id}:
    get:
      tags:
        - Tasks
      summary: Get a specific task by ID
      description: Returns a specific task for the specified user.
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: task_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '200':
          description: Task retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      security:
        - bearerAuth: []

    put:
      tags:
        - Tasks
      summary: Update a task's title and/or description
      description: Updates an existing task for the specified user.
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: task_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TaskUpdate'
      responses:
        '200':
          description: Task updated successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '400':
          $ref: '#/components/responses/BadRequest'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      security:
        - bearerAuth: []

    delete:
      tags:
        - Tasks
      summary: Delete a task permanently
      description: Deletes a task for the specified user.
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: task_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Task deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      security:
        - bearerAuth: []

  /api/{user_id}/tasks/{task_id}/complete:
    patch:
      tags:
        - Tasks
      summary: Toggle task completion status
      description: Toggles the completion status of a task.
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: task_id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                completed:
                  type: boolean
              required:
                - completed
      responses:
        '200':
          description: Task completion status updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TaskResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      security:
        - bearerAuth: []

  # ==========================================
  # PHASE III ENDPOINTS (New)
  # ==========================================

  /api/{user_id}/chat:
    post:
      tags:
        - Chat
      summary: Send a message to the AI chatbot
      description: |
        Send a natural language message to the AI chatbot for task management.

        The chatbot can:
        - Create tasks: "Add a task to buy groceries"
        - List tasks: "Show me all my tasks" or "What's pending?"
        - Complete tasks: "Mark task 3 as complete"
        - Update tasks: "Change task 1 to 'Call mom tonight'"
        - Delete tasks: "Delete task 4"

        The endpoint is stateless - conversation history is loaded from the database
        for each request and the server maintains no in-memory session state.
      parameters:
        - name: user_id
          in: path
          required: true
          description: The ID of the authenticated user
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ChatRequest'
            examples:
              new_conversation:
                summary: Start a new conversation
                value:
                  message: "Add a task to buy groceries"
              existing_conversation:
                summary: Continue existing conversation
                value:
                  conversation_id: 123
                  message: "What are my pending tasks?"
      responses:
        '200':
          description: Message processed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ChatResponse'
              examples:
                task_created:
                  summary: Task created via chat
                  value:
                    conversation_id: 123
                    response: "I've added 'Buy groceries' to your task list. Task ID: 42"
                    tool_calls: ["add_task"]
                    timestamp: "2026-01-26T10:00:00Z"
                task_listed:
                  summary: Tasks listed via chat
                  value:
                    conversation_id: 123
                    response: "You have 3 pending tasks:\n1. Buy groceries\n2. Call mom\n3. Finish report"
                    tool_calls: ["list_tasks"]
                    timestamp: "2026-01-26T10:01:00Z"
        '400':
          description: Bad request - invalid input
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                empty_message:
                  summary: Empty message
                  value:
                    error: "Message is required"
                    code: "INVALID_REQUEST"
                message_too_long:
                  summary: Message exceeds length limit
                  value:
                    error: "Message must be 2000 characters or less"
                    code: "INVALID_REQUEST"
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          description: Forbidden - user does not have access to this conversation
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
        '429':
          description: Too many requests - rate limit exceeded
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "Rate limit exceeded. Please wait before sending more messages."
                code: "RATE_LIMIT_EXCEEDED"
        '500':
          description: Internal server error - AI processing failed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              example:
                error: "AI service temporarily unavailable. Please try again."
                code: "AI_SERVICE_ERROR"
      security:
        - bearerAuth: []

  /api/{user_id}/conversations:
    get:
      tags:
        - Conversations
      summary: List all conversations for the authenticated user
      description: Returns all conversations for the specified user, ordered by last update (newest first).
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: limit
          in: query
          required: false
          description: Maximum number of conversations to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
        - name: offset
          in: query
          required: false
          description: Number of conversations to skip
          schema:
            type: integer
            default: 0
            minimum: 0
      responses:
        '200':
          description: Conversations retrieved successfully
          content:
            application/json:
              schema:
                type: object
                properties:
                  conversations:
                    type: array
                    items:
                      $ref: '#/components/schemas/ConversationResponse'
                  total:
                    type: integer
                    description: Total number of conversations
                  limit:
                    type: integer
                  offset:
                    type: integer
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
      security:
        - bearerAuth: []

  /api/{user_id}/conversations/{conversation_id}:
    get:
      tags:
        - Conversations
      summary: Get conversation details with message history
      description: Returns a specific conversation with its complete message history.
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: conversation_id
          in: path
          required: true
          schema:
            type: integer
        - name: limit
          in: query
          required: false
          description: Maximum number of messages to return
          schema:
            type: integer
            default: 50
            minimum: 1
            maximum: 100
      responses:
        '200':
          description: Conversation retrieved successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ConversationDetailResponse'
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      security:
        - bearerAuth: []

    delete:
      tags:
        - Conversations
      summary: Delete a conversation and all its messages
      description: Permanently deletes a conversation and all associated messages.
      parameters:
        - name: user_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: conversation_id
          in: path
          required: true
          schema:
            type: integer
      responses:
        '204':
          description: Conversation deleted successfully
        '401':
          $ref: '#/components/responses/Unauthorized'
        '403':
          $ref: '#/components/responses/Forbidden'
        '404':
          $ref: '#/components/responses/NotFound'
      security:
        - bearerAuth: []

  # ==========================================
  # UTILITY ENDPOINTS
  # ==========================================

  /health:
    get:
      tags:
        - Health
      summary: Health check endpoint
      description: Returns the health status of the API and its dependencies.
      responses:
        '200':
          description: API is healthy
          content:
            application/json:
              schema:
                type: object
                properties:
                  status:
                    type: string
                    example: healthy
                  timestamp:
                    type: string
                    format: date-time
                  version:
                    type: string
                    example: 2.0.0
                  services:
                    type: object
                    properties:
                      database:
                        type: string
                        enum: [healthy, unhealthy]
                      openai:
                        type: string
                        enum: [healthy, unhealthy]

  /:
    get:
      tags:
        - Info
      summary: Root endpoint
      description: Returns basic information about the API.
      responses:
        '200':
          description: API information
          content:
            application/json:
              schema:
                type: object
                properties:
                  message:
                    type: string
                    example: Todo AI Chatbot API
                  version:
                    type: string
                    example: 2.0.0
                  phase:
                    type: string
                    example: Phase III - AI Chatbot
                  docs:
                    type: string
                    example: /docs

components:
  schemas:
    # ==========================================
    # AUTHENTICATION SCHEMAS
    # ==========================================

    UserSignup:
      type: object
      properties:
        email:
          type: string
          format: email
          description: User's email address
          example: user@example.com
        password:
          type: string
          minLength: 8
          maxLength: 128
          description: User's password (min 8 chars)
          example: securePassword123
        name:
          type: string
          maxLength: 100
          description: User's display name
          example: John Doe
      required:
        - email
        - password

    UserSignin:
      type: object
      properties:
        email:
          type: string
          format: email
          example: user@example.com
        password:
          type: string
          example: securePassword123
      required:
        - email
        - password

    UserResponse:
      type: object
      properties:
        id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        email:
          type: string
          format: email
          example: user@example.com
        name:
          type: string
          example: John Doe
        created_at:
          type: string
          format: date-time
          example: 2026-01-19T10:00:00Z

    AuthResponse:
      type: object
      properties:
        token:
          type: string
          description: JWT access token
          example: eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...
        user:
          $ref: '#/components/schemas/UserResponse'

    # ==========================================
    # TASK SCHEMAS
    # ==========================================

    TaskCreate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
          description: Task title (required)
          example: Buy groceries
        description:
          type: string
          maxLength: 1000
          description: Task description (optional)
          example: Milk, eggs, bread
      required:
        - title

    TaskUpdate:
      type: object
      properties:
        title:
          type: string
          minLength: 1
          maxLength: 200
          example: Buy groceries and cook dinner
        description:
          type: string
          maxLength: 1000
          example: Milk, eggs, bread, and ingredients for dinner

    TaskResponse:
      type: object
      properties:
        id:
          type: integer
          example: 1
        user_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        title:
          type: string
          example: Buy groceries
        description:
          type: string
          nullable: true
          example: Milk, eggs, bread
        completed:
          type: boolean
          example: false
        created_at:
          type: string
          format: date-time
          example: 2026-01-19T10:00:00Z
        updated_at:
          type: string
          format: date-time
          example: 2026-01-19T10:00:00Z

    # ==========================================
    # CHAT SCHEMAS (Phase III)
    # ==========================================

    ChatRequest:
      type: object
      properties:
        conversation_id:
          type: integer
          nullable: true
          description: |
            Existing conversation ID to continue.
            If not provided, a new conversation will be created.
          example: 123
        message:
          type: string
          minLength: 1
          maxLength: 2000
          description: User's natural language message
          example: "Add a task to buy groceries"
      required:
        - message

    ChatResponse:
      type: object
      properties:
        conversation_id:
          type: integer
          description: The conversation ID (new or existing)
          example: 123
        response:
          type: string
          description: AI assistant's natural language response
          example: "I've added 'Buy groceries' to your task list. Task ID: 42"
        tool_calls:
          type: array
          items:
            type: string
          description: List of MCP tools invoked during processing
          example: ["add_task"]
        timestamp:
          type: string
          format: date-time
          description: When the response was generated
          example: 2026-01-26T10:00:00Z

    # ==========================================
    # CONVERSATION SCHEMAS (Phase III)
    # ==========================================

    ConversationResponse:
      type: object
      properties:
        id:
          type: integer
          example: 123
        user_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        created_at:
          type: string
          format: date-time
          example: 2026-01-26T09:00:00Z
        updated_at:
          type: string
          format: date-time
          example: 2026-01-26T10:00:00Z
        message_count:
          type: integer
          description: Total number of messages in conversation
          example: 10
        last_message_preview:
          type: string
          description: Preview of the last message (first 100 chars)
          example: "I've added 'Buy groceries' to your task list..."

    MessageResponse:
      type: object
      properties:
        id:
          type: integer
          example: 456
        conversation_id:
          type: integer
          example: 123
        user_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        role:
          type: string
          enum: [user, assistant]
          description: Who sent the message
          example: user
        content:
          type: string
          description: Message content
          example: "Add a task to buy groceries"
        created_at:
          type: string
          format: date-time
          example: 2026-01-26T10:00:00Z

    ConversationDetailResponse:
      type: object
      properties:
        id:
          type: integer
          example: 123
        user_id:
          type: string
          format: uuid
          example: 550e8400-e29b-41d4-a716-446655440000
        created_at:
          type: string
          format: date-time
          example: 2026-01-26T09:00:00Z
        updated_at:
          type: string
          format: date-time
          example: 2026-01-26T10:00:00Z
        messages:
          type: array
          items:
            $ref: '#/components/schemas/MessageResponse'
          description: Message history (ordered by created_at ascending)

    # ==========================================
    # ERROR SCHEMAS
    # ==========================================

    Error:
      type: object
      properties:
        error:
          type: string
          description: Human-readable error message
          example: Invalid email or password
        code:
          type: string
          description: Machine-readable error code
          example: INVALID_CREDENTIALS
        details:
          type: object
          nullable: true
          description: Additional error details
        timestamp:
          type: string
          format: date-time
          example: 2026-01-26T10:00:00Z

  # ==========================================
  # REUSABLE RESPONSES
  # ==========================================

  responses:
    BadRequest:
      description: Bad request - invalid input
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Unauthorized:
      description: Unauthorized - invalid or missing token
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    Forbidden:
      description: Forbidden - user does not have access
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

    NotFound:
      description: Not found - resource does not exist
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/Error'

  # ==========================================
  # SECURITY SCHEMES
  # ==========================================

  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        JWT token required for authentication.

        Obtain token via /api/auth/signup or /api/auth/signin endpoints.

        Include in Authorization header: `Authorization: Bearer <token>`

security:
  - bearerAuth: []

tags:
  - name: Authentication
    description: User registration and sign in endpoints
  - name: Tasks
    description: Task management endpoints (Phase II)
  - name: Chat
    description: AI chatbot conversational interface (Phase III)
  - name: Conversations
    description: Conversation history management (Phase III)
  - name: Health
    description: Health check endpoint
  - name: Info
    description: Informational endpoints
